{% extends 'admin_layout.html' %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>{{ 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø§Ù…ÙˆØ±ÛŒØª' if assignment else 'Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø¬Ø¯ÛŒØ¯' }}</h2>
    </div>
    <div class="card-body">
        <form method="post">
            <div class="form-group">
                <label for="guide_name" class="form-label">Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ø±Ø§Ù‡Ù†Ù…Ø§:</label>
                <input type="text" name="guide_name" id="guide_name" class="form-control" value="{{ assignment['guide_name'] if assignment else '' }}" required>
            </div>
            <div class="form-group">
                <label for="guide_national_id" class="form-label">Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¯ÛŒØ± Ø±Ø§Ù‡Ù†Ù…Ø§:</label>
                <input type="text" name="guide_national_id" id="guide_national_id" class="form-control" value="{{ assignment['guide_national_id'] if assignment else '' }}" required>
            </div>

            <div class="form-group" style="position: relative;">
                <label class="form-label">Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ®ÛŒ Ù…Ø§Ù…ÙˆØ±ÛŒØª (ÙˆØ±ÙˆØ¯ Ùˆ Ø®Ø±ÙˆØ¬):</label>
                <div class="date-input-wrapper">
                    <input type="text" id="daterange-display" class="form-control text-center" placeholder="Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯" readonly>
                </div>
                
                <div class="persian-calendar" id="persianCalendar">
                    <div class="calendar-container">
                        <div class="calendar-month" id="calendar1">
                            <div class="calendar-header">
                                <button type="button" class="nav-btn" id="prevMonth">â–¶</button>
                                <span id="monthYear1"></span>
                                <button type="button" class="nav-btn" id="nextMonth">â—€</button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid1"></div>
                        </div>
                        <div class="calendar-month" id="calendar2">
                            <div class="calendar-header">
                                <span id="monthYear2"></span>
                            </div>
                            <div class="calendar-grid" id="calendarGrid2"></div>
                        </div>
                    </div>
                    <div class="calendar-footer">
                        <button type="button" class="btn btn-light" id="goToTodayBtn">Ø¨Ø±Ùˆ Ø¨Ù‡ Ø§Ù…Ø±ÙˆØ²</button>
                        <div style="flex-grow: 1;"></div> <button type="button" class="btn btn-secondary" id="cancelBtn">Ø§Ù†ØµØ±Ø§Ù</button>
                        <button type="button" class="btn btn-success" id="applyBtn">ØªØ§ÛŒÛŒØ¯</button>
                    </div>
                </div>
            </div>

            <input type="hidden" name="enter_date" id="enter_date" value="{{ assignment.enter_date if assignment else '' }}">
            <input type="hidden" name="exit_date" id="exit_date" value="{{ assignment.exit_date if assignment else '' }}">
            
            <div class="form-group">
              <label for="city" class="form-label">Ø´Ù‡Ø±:</label>
              <input type="text" name="city" id="city" class="form-control" value="{{ assignment['city'] if assignment else '' }}" required>
            </div>
            <div class="form-group">
              <label for="hotel_name" class="form-label">Ù†Ø§Ù… Ù‡ØªÙ„:</label>
              <input type="text" name="hotel_name" id="hotel_name" class="form-control" value="{{ assignment['hotel_name'] if assignment else '' }}" required>
            </div>
            <div class="form-group">
              <label for="fixed_manager_name" class="form-label">Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ø«Ø§Ø¨Øª:</label>
              <input type="text" name="fixed_manager_name" id="fixed_manager_name" class="form-control" value="{{ assignment['fixed_manager_name'] if assignment else '' }}" required>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
                <a href="{{ url_for('admin_index') }}" class="btn btn-secondary ms-3">Ø§Ù†ØµØ±Ø§Ù</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}


{% block scripts %}
<style>
    /* ... Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± ... */
    .form-group{margin-bottom:20px}.form-label{display:block;font-weight:600;color:#333;margin-bottom:8px;font-size:14px}.form-control{width:100%;border-radius:15px;border:2px solid #e0e0e0;padding:12px 20px;font-size:16px;transition:all .3s ease;background:white;box-sizing:border-box; font-family: 'Vazirmatn', sans-serif;}.form-control:focus{border-color:#667eea;outline:none;box-shadow:0 0 0 3px rgba(102,126,234,.1);transform:translateY(-2px)}.btn{border-radius:15px;padding:12px 30px;font-weight:600;transition:all .3s ease;border:none;cursor:pointer;font-size:16px;text-decoration:none;display:inline-block;text-align:center; font-family: 'Vazirmatn', sans-serif;}.btn-success{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}.btn-success:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.3)}.btn-secondary{background:#6c757d;color:white}.btn-secondary:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(108,117,125,.3);background:#5a6268}.date-input-wrapper{position:relative}.date-input-wrapper::after{content:'ğŸ“…';position:absolute;left:15px;top:50%;transform:translateY(-50%);pointer-events:none;font-size:18px}
    
    .persian-calendar {
        display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 9999;
        background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,.2);
        border: 1px solid #e0e0e0; overflow: hidden; margin-top: 5px; min-width: 600px;
        font-family: 'Vazirmatn', sans-serif;
    }
    
    .persian-calendar.active{display:block !important}.calendar-container{display:flex;width:100%}.calendar-month{flex:1;min-width:300px}.calendar-header{padding:15px;text-align:center;font-weight:600;display:flex;align-items:center;justify-content:space-between;background:#f8f9fa;border-bottom:1px solid #e0e0e0}.nav-btn{background:none;border:none;color:#555;font-size:18px;cursor:pointer;padding:8px 12px;border-radius:50%;transition:all .3s ease}.nav-btn:hover{background:rgba(0,0,0,.1)}.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#f0f0f0;padding:10px}.calendar-day-header{background:#f8f9fa;padding:10px;text-align:center;font-weight:600;font-size:14px;color:#666}
    
    /* ÙÙˆÙ†Øª ÙˆØ²ÛŒØ± Ø¨Ù‡ Ø·ÙˆØ± Ù…Ø´Ø®Øµ Ø¨Ù‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯ */
    .calendar-day{background:white;padding:10px;text-align:center;cursor:pointer;transition:all .3s ease;font-size:14px;border:none;min-height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px; font-family: 'Vazirmatn', sans-serif;}

    .calendar-day:hover{background:rgba(102,126,234,.1);transform:scale(1.05)}.calendar-day.other-month{color:#ccc;cursor:default;pointer-events:none}.calendar-day.today{border:2px solid #667eea;font-weight:bold}.calendar-day.selected,.calendar-day.start-date,.calendar-day.end-date{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;font-weight:bold}.calendar-day.in-range{background:rgba(102,126,234,.2);color:#333;border-radius:0}.calendar-day.start-date{border-top-right-radius:8px;border-bottom-right-radius:8px}.calendar-day.end-date{border-top-left-radius:8px;border-bottom-left-radius:8px}
    
    /* Ø§Ø³ØªØ§ÛŒÙ„ ÙÙˆØªØ± Ø¨Ø±Ø§ÛŒ Ú†ÛŒØ¯Ù…Ø§Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
    .calendar-footer{padding:15px;text-align:center;border-top:1px solid #e0e0e0;background:#f8f9fa; display: flex; align-items: center;}

    .calendar-footer .btn{margin:0 5px;padding:8px 20px;font-size:14px; font-family: 'Vazirmatn', sans-serif;}
    .calendar-footer .btn-light { background-color: #f8f9fa; color: #0d6efd; border: 1px solid #e0e0e0; }
    .calendar-footer .btn-light:hover { background-color: #e9ecef; }
    
    .calendar-day.disabled{color:#ccc;cursor:not-allowed;pointer-events:none;background:#f5f5f5}.calendar-day.disabled:hover{background:#f5f5f5;transform:none}@media (max-width:768px){.calendar-container{flex-direction:column}.calendar-month{min-width:auto}.persian-calendar{min-width:100%}}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    class PersianDateConverter {
        gregorianToJalali(g_y, g_m, g_d) {
            var g_days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            var j_days_in_month = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
            var gy = g_y - 1600; var gm = g_m - 1; var gd = g_d - 1;
            var g_day_no = 365 * gy + Math.floor((gy + 3) / 4) - Math.floor((gy + 99) / 100) + Math.floor((gy + 399) / 400);
            for (var j = 0; j < gm; ++j) g_day_no += g_days_in_month[j];
            if (gm > 1 && ((gy % 4 == 0 && gy % 100 != 0) || (gy % 400 == 0))) g_day_no++;
            g_day_no += gd;
            var j_day_no = g_day_no - 79;
            var j_np = Math.floor(j_day_no / 12053);
            j_day_no = j_day_no % 12053;
            var jy = 979 + 33 * j_np + 4 * Math.floor(j_day_no / 1461);
            j_day_no %= 1461;
            if (j_day_no >= 366) { jy += Math.floor((j_day_no - 1) / 365); j_day_no = (j_day_no - 1) % 365; }
            var jm;
            for (var m = 0; m < 11 && j_day_no >= j_days_in_month[m]; ++m) j_day_no -= j_days_in_month[m];
            jm = m + 1;
            var jd = j_day_no + 1;
            return [jy, jm, jd];
        }
        jalaliToGregorian(j_y, j_m, j_d) {
            var g_days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            var j_days_in_month = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
            var jy = j_y - 979; var jm = j_m - 1; var jd = j_d - 1;
            var j_day_no = 365 * jy + Math.floor(jy / 33) * 8 + Math.floor((jy % 33 + 3) / 4);
            for (var k = 0; k < jm; ++k) j_day_no += j_days_in_month[k];
            j_day_no += jd;
            var g_day_no = j_day_no + 79;
            var gy = 1600 + 400 * Math.floor(g_day_no / 146097);
            g_day_no = g_day_no % 146097;
            var leap = true;
            if (g_day_no >= 36525) { g_day_no--; gy += 100 * Math.floor(g_day_no / 36524); g_day_no = g_day_no % 36524; if (g_day_no >= 365) g_day_no++; else leap = false; }
            gy += 4 * Math.floor(g_day_no / 1461);
            g_day_no %= 1461;
            if (g_day_no >= 366) { leap = false; g_day_no--; gy += Math.floor(g_day_no / 365); g_day_no = g_day_no % 365; }
            let idx;
            for (idx = 0; g_day_no >= g_days_in_month[idx] + (idx === 1 && leap); idx++) g_day_no -= g_days_in_month[idx] + (idx === 1 && leap);
            var gm = idx + 1;
            var gd = g_day_no + 1;
            return new Date(gy, gm - 1, gd);
        }
    }

    class PersianCalendar {
        constructor() {
            this.container = document.getElementById('persianCalendar');
            this.dateConverter = new PersianDateConverter();
            this.persianMonths = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];
            this.persianDays = ['Ø´', 'ÛŒ', 'Ø¯', 'Ø³', 'Ú†', 'Ù¾', 'Ø¬'];
            this.today = new Date();
            this.today.setHours(0, 0, 0, 0);
            this.displayDate = new Date(this.today);
            this.selectedStartDate = null;
            this.selectedEndDate = null;
            this.init();
        }
        
        toPersianDigits(str) {
            const persianDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
            return String(str).replace(/[0-9]/g, function(w) { return persianDigits[+w]; });
        }

        isPersianLeapYear(year) {
            return (((((year - 474) % 2820) + 474) + 38) * 682) % 2816 < 682;
        }

        init() {
            const enterDateVal = document.getElementById('enter_date').value;
            const exitDateVal = document.getElementById('exit_date').value;
            if (enterDateVal) {
                this.selectedStartDate = this.parseDate(enterDateVal);
                if (this.selectedStartDate < this.today) { this.displayDate = new Date(this.selectedStartDate); }
            }
            if (exitDateVal) { this.selectedEndDate = this.parseDate(exitDateVal); }
            this.bindEvents();
            this.render();
            if (this.selectedStartDate && this.selectedEndDate) { this.updateDisplayInput(); }
        }

        parseDate(dateStr) {
            const parts = dateStr.split('/');
            return this.dateConverter.jalaliToGregorian(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]));
        }

        bindEvents() {
            const displayInput = document.getElementById('daterange-display');
            displayInput.addEventListener('click', (e) => { e.stopPropagation(); this.container.classList.add('active'); });
            document.addEventListener('click', (e) => { if (!this.container.contains(e.target) && !displayInput.contains(e.target)) { this.container.classList.remove('active'); } });
            this.container.addEventListener('click', (e) => { e.stopPropagation(); });
            document.getElementById('prevMonth').addEventListener('click', () => this.changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => this.changeMonth(1));
            document.getElementById('applyBtn').addEventListener('click', () => this.applySelection());
            document.getElementById('cancelBtn').addEventListener('click', () => this.container.classList.remove('active'));
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø¬Ø¯ÛŒØ¯ "Ø¨Ø±Ùˆ Ø¨Ù‡ Ø§Ù…Ø±ÙˆØ²"
            document.getElementById('goToTodayBtn').addEventListener('click', () => this.selectToday());
        }
        
        // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ²
        selectToday() {
            this.displayDate = new Date(this.today);
            this.selectedStartDate = this.today;
            this.selectedEndDate = this.today;
            this.render();
        }

        renderMonth(element, date) {
            const [jy, jm] = this.dateConverter.gregorianToJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
            element.querySelector('.calendar-header span').textContent = `${this.persianMonths[jm - 1]} ${this.toPersianDigits(jy)}`;
            const gridElement = element.querySelector('.calendar-grid');
            gridElement.innerHTML = '';
            this.persianDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                gridElement.appendChild(dayHeader);
            });
            const firstDayOfMonth = this.dateConverter.jalaliToGregorian(jy, jm, 1).getDay();
            const startOffset = (firstDayOfMonth + 1) % 7;
            const daysInMonth = (jm <= 6) ? 31 : (jm <= 11) ? 30 : (this.isPersianLeapYear(jy) ? 30 : 29);
            for (let i = 0; i < startOffset; i++) { gridElement.appendChild(document.createElement('div')); }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('button');
                dayElement.type = 'button';
                dayElement.className = 'calendar-day';
                dayElement.textContent = this.toPersianDigits(day);
                const currentDayGregorian = this.dateConverter.jalaliToGregorian(jy, jm, day);
                if (currentDayGregorian < this.today) { dayElement.classList.add('disabled'); }
                if (this.isSameDay(currentDayGregorian, this.today)) { dayElement.classList.add('today'); }
                if (this.selectedStartDate && this.isSameDay(currentDayGregorian, this.selectedStartDate)) { dayElement.classList.add('start-date', 'selected'); }
                if (this.selectedEndDate && this.isSameDay(currentDayGregorian, this.selectedEndDate)) { dayElement.classList.add('end-date', 'selected'); }
                if (this.selectedStartDate && this.selectedEndDate && currentDayGregorian > this.selectedStartDate && currentDayGregorian < this.selectedEndDate) { dayElement.classList.add('in-range'); }
                dayElement.addEventListener('click', (e) => { e.stopPropagation(); this.selectDate(currentDayGregorian); });
                gridElement.appendChild(dayElement);
            }
        }
        render() {
            const calendar1 = document.getElementById('calendar1');
            const calendar2 = document.getElementById('calendar2');
            this.renderMonth(calendar1, this.displayDate);
            const nextMonthDate = new Date(this.displayDate);
            nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
            this.renderMonth(calendar2, nextMonthDate);
        }
        selectDate(date) {
            if (!this.selectedStartDate || (this.selectedStartDate && this.selectedEndDate)) {
                if (date < this.today) return;
                this.selectedStartDate = date;
                this.selectedEndDate = null;
            } else if (date < this.selectedStartDate) {
                if (date < this.today) return;
                this.selectedEndDate = this.selectedStartDate;
                this.selectedStartDate = date;
            } else { this.selectedEndDate = date; }
            this.render();
        }
        changeMonth(offset) {
            this.displayDate.setMonth(this.displayDate.getMonth() + offset);
            this.render();
        }
        applySelection() {
            if (this.selectedStartDate && this.selectedEndDate) {
                this.updateDisplayInput();
                this.container.classList.remove('active');
            } else { alert('Ù„Ø·ÙØ§ Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ®ÛŒ Ø±Ø§ Ú©Ø§Ù…Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù†).'); }
        }
        updateDisplayInput() {
            const startJalali = this.dateConverter.gregorianToJalali(this.selectedStartDate.getFullYear(), this.selectedStartDate.getMonth() + 1, this.selectedStartDate.getDate());
            const endJalali = this.dateConverter.gregorianToJalali(this.selectedEndDate.getFullYear(), this.selectedEndDate.getMonth() + 1, this.selectedEndDate.getDate());
            const formatJalali = (d) => `${this.toPersianDigits(d[0])}/${this.toPersianDigits(String(d[1]).padStart(2, '0'))}/${this.toPersianDigits(String(d[2]).padStart(2, '0'))}`;
            document.getElementById('daterange-display').value = `${formatJalali(startJalali)}   -   ${formatJalali(endJalali)}`;
            const formatForStorage = (d) => `${d[0]}/${String(d[1]).padStart(2, '0')}/${String(d[2]).padStart(2, '0')}`;
            document.getElementById('enter_date').value = formatForStorage(startJalali);
            document.getElementById('exit_date').value = formatForStorage(endJalali);
        }
        isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        }
    }
    new PersianCalendar();
});
</script>
{% endblock %}
