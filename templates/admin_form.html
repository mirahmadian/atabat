{% extends 'admin_layout.html' %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>{{ 'ویرایش ماموریت' if assignment else 'افزودن ماموریت جدید' }}</h2>
    </div>
    <div class="card-body">
        <form method="post">
            <div class="form-group">
                <label for="guide_name" class="form-label">نام مدیر راهنما:</label>
                <input type="text" name="guide_name" id="guide_name" class="form-control" value="{{ assignment['guide_name'] if assignment else '' }}" required>
            </div>
            <div class="form-group">
                <label for="guide_national_id" class="form-label">کد ملی مدیر راهنما:</label>
                <input type="text" name="guide_national_id" id="guide_national_id" class="form-control" value="{{ assignment['guide_national_id'] if assignment else '' }}" required>
            </div>

            <div class="form-group" style="position: relative;">
                <label class="form-label">بازه تاریخی ماموریت (ورود و خروج):</label>
                <div class="date-input-wrapper">
                    <input type="text" id="daterange-display" class="form-control text-center" placeholder="برای انتخاب تاریخ کلیک کنید" readonly>
                </div>
                
                <div class="persian-calendar" id="persianCalendar">
                    <div class="calendar-container">
                        <div class="calendar-month" id="calendar1">
                            <div class="calendar-header">
                                <button type="button" class="nav-btn" id="prevMonth">›</button>
                                <span id="monthYear1"></span>
                            </div>
                            <div class="calendar-grid" id="calendarGrid1"></div>
                        </div>
                        <div class="calendar-month" id="calendar2">
                            <div class="calendar-header">
                                <span id="monthYear2"></span>
                                <button type="button" class="nav-btn" id="nextMonth">‹</button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid2"></div>
                        </div>
                    </div>
                    <div class="calendar-footer">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">انصراف</button>
                        <button type="button" class="btn btn-success" id="applyBtn">تایید</button>
                    </div>
                </div>
            </div>

            <input type="hidden" name="enter_date" id="enter_date" value="{{ assignment['enter_date'] if assignment else '' }}">
            <input type="hidden" name="exit_date" id="exit_date" value="{{ assignment['exit_date'] if assignment else '' }}">
            
            <div class="form-group">
              <label for="city" class="form-label">شهر:</label>
              <input type="text" name="city" id="city" class="form-control" value="{{ assignment['city'] if assignment else '' }}" required>
            </div>
            <div class="form-group">
              <label for="hotel_name" class="form-label">نام هتل:</label>
              <input type="text" name="hotel_name" id="hotel_name" class="form-control" value="{{ assignment['hotel_name'] if assignment else '' }}" required>
            </div>
            <div class="form-group">
              <label for="fixed_manager_name" class="form-label">نام مدیر ثابت:</label>
              <input type="text" name="fixed_manager_name" id="fixed_manager_name" class="form-control" value="{{ assignment['fixed_manager_name'] if assignment else '' }}" required>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary">💾 ذخیره</button>
                <a href="{{ url_for('admin_index') }}" class="btn btn-light ms-3">انصراف</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}


{% block scripts %}
<style>
    /* 🎨 استایل‌های پایه و عمومی فرم */
    .form-group{margin-bottom:1.25rem}.form-label{display:block;font-weight:600;color:#333;margin-bottom:0.5rem;font-size:0.9rem}.form-control{width:100%;border-radius:8px;border:1px solid #ced4da;padding:0.75rem 1rem;font-size:1rem;transition:all .2s ease;background-color:#fff;font-family:'Vazirmatn',sans-serif}.form-control:focus{border-color:#86b7fe;outline:0;box-shadow:0 0 0 0.25rem rgba(13,110,253,.25)}.btn{border-radius:8px;padding:0.75rem 1.5rem;font-weight:600;transition:all .2s ease;border:none;cursor:pointer;font-size:1rem;font-family:'Vazirmatn',sans-serif;text-decoration:none;display:inline-block;text-align:center}.btn-primary{background-color:#0d6efd;color:#fff}.btn-primary:hover{background-color:#0b5ed7}.btn-light{background-color:#f8f9fa;color:#000;border:1px solid #ced4da}.btn-light:hover{background-color:#e2e6ea}.ms-3{margin-right:1rem}.mt-4{margin-top:1.5rem}.text-center{text-align:center}.date-input-wrapper{position:relative}.date-input-wrapper::after{content:'📅';position:absolute;left:1rem;top:50%;transform:translateY(-50%);pointer-events:none;font-size:1.2rem}

    /* 🎨 استایل‌های اصلی تقویم */
    .persian-calendar {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
        margin-top: 8px;
        padding: 10px;
        width: 100%;
        min-width: 620px; /* برای نمایش دو ماه در کنار هم */
        box-sizing: border-box;
    }
    .persian-calendar.active { display: block; }
    .calendar-container { display: flex; gap: 20px; }
    .calendar-month { flex: 1; }

    /* 🎨 استایل هدر تقویم (نام ماه و دکمه‌های ناوبری) */
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 5px;
        font-weight: bold;
        font-size: 1.1rem;
    }
    .nav-btn {
        background: none;
        border: none;
        color: #555;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0 10px;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        line-height: 40px;
        text-align: center;
        transition: background-color 0.2s ease;
    }
    .nav-btn:hover { background-color: #f0f0f0; }
    /* تغییر جهت دکمه‌های چپ و راست */
    #prevMonth { order: 1; }
    #monthYear1 { order: 2; flex-grow: 1; text-align: right; }
    #monthYear2 { flex-grow: 1; text-align: left;}
    #nextMonth { order: 3; }

    /* 🎨 استایل گرید اصلی روزها */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }
    .calendar-day-header {
        text-align: center;
        font-weight: normal;
        font-size: 0.85rem;
        color: #6c757d;
        padding: 10px 0;
    }
    .calendar-day {
        background: none;
        padding: 0;
        text-align: center;
        cursor: pointer;
        font-size: 0.95rem;
        border: none;
        border-radius: 50%;
        height: 40px;
        width: 40px;
        margin: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    /* 🎨 استایل حالت‌های مختلف روزها */
    .calendar-day:not(.disabled):hover { background-color: #e9ecef; }
    .calendar-day.today { font-weight: bold; border: 1px solid #0d6efd; }
    .calendar-day.disabled { color: #adb5bd; cursor: not-allowed; background: none; }
    
    /* استایل بازه انتخاب شده */
    .calendar-day.in-range {
        background-color: rgba(13, 110, 253, 0.1);
        border-radius: 0;
        color: #000;
    }
    .calendar-day.start-date, .calendar-day.end-date {
        background-color: #0d6efd;
        color: white;
        font-weight: bold;
    }
    /* گرد کردن گوشه‌ها برای ایجاد ظاهر یکپارچه */
    td.in-range:first-child .calendar-day,
    .calendar-day.start-date { border-top-left-radius: 50%; border-bottom-left-radius: 50%; }
    td.in-range:last-child .calendar-day,
    .calendar-day.end-date { border-top-right-radius: 50%; border-bottom-right-radius: 50%; }

    /* 🎨 استایل فوتر تقویم */
    .calendar-footer {
        padding: 15px 10px 5px;
        text-align: left;
        border-top: 1px solid #eee;
        margin-top: 10px;
    }
    .calendar-footer .btn { margin-left: 10px; }

    /* 🎨 واکنش‌گرایی برای موبایل */
    @media (max-width: 640px) {
        .persian-calendar { min-width: 300px; }
        .calendar-container { flex-direction: column; gap: 0;}
    }
</style>

<script>
// این بخش جاوا اسکریپت بدون تغییر باقی می‌ماند چون منطق آن صحیح است.
document.addEventListener("DOMContentLoaded", function() {
    class PersianDateConverter {
        gregorianToJalali(g_y, g_m, g_d) {
            var g_days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            var j_days_in_month = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
            var gy = g_y - 1600;
            var gm = g_m - 1;
            var gd = g_d - 1;
            var g_day_no = 365 * gy + Math.floor((gy + 3) / 4) - Math.floor((gy + 99) / 100) + Math.floor((gy + 399) / 400);
            for (var i = 0; i < gm; ++i) g_day_no += g_days_in_month[i];
            if (gm > 1 && ((gy % 4 == 0 && gy % 100 != 0) || (gy % 400 == 0))) g_day_no++;
            g_day_no += gd;
            var j_day_no = g_day_no - 79;
            var j_np = Math.floor(j_day_no / 12053);
            j_day_no = j_day_no % 12053;
            var jy = 979 + 33 * j_np + 4 * Math.floor(j_day_no / 1461);
            j_day_no %= 1461;
            if (j_day_no >= 366) {
                jy += Math.floor((j_day_no - 1) / 365);
                j_day_no = (j_day_no - 1) % 365;
            }
            var jm;
            for (var i = 0; i < 11 && j_day_no >= j_days_in_month[i]; ++i) j_day_no -= j_days_in_month[i];
            jm = i + 1;
            var jd = j_day_no + 1;
            return [jy, jm, jd];
        }

        jalaliToGregorian(j_y, j_m, j_d) {
            var g_days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            var j_days_in_month = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
            var jy = j_y - 979;
            var jm = j_m - 1;
            var jd = j_d - 1;
            var j_day_no = 365 * jy + Math.floor(jy / 33) * 8 + Math.floor((jy % 33 + 3) / 4);
            for (var i = 0; i < jm; ++i) j_day_no += j_days_in_month[i];
            j_day_no += jd;
            var g_day_no = j_day_no + 79;
            var gy = 1600 + 400 * Math.floor(g_day_no / 146097);
            g_day_no = g_day_no % 146097;
            var leap = true;
            if (g_day_no >= 36525) {
                g_day_no--;
                gy += 100 * Math.floor(g_day_no / 36524);
                g_day_no = g_day_no % 36524;
                if (g_day_no >= 365) g_day_no++;
                else leap = false;
            }
            gy += 4 * Math.floor(g_day_no / 1461);
            g_day_no %= 1461;
            if (g_day_no >= 366) {
                leap = false;
                g_day_no--;
                gy += Math.floor(g_day_no / 365);
                g_day_no = g_day_no % 365;
            }
            let i;
            for (i = 0; g_day_no >= g_days_in_month[i] + (i === 1 && leap); i++) g_day_no -= g_days_in_month[i] + (i === 1 && leap);
            var gm = i + 1;
            var gd = g_day_no + 1;
            return new Date(gy, gm -1, gd);
        }
    }

    class PersianCalendar {
        constructor() {
            this.container = document.getElementById('persianCalendar');
            this.dateConverter = new PersianDateConverter();
            this.persianMonths = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];
            this.persianDays = ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'];
            this.today = new Date();
            this.today.setHours(0, 0, 0, 0);
            this.displayDate = new Date(this.today);
            this.selectedStartDate = null;
            this.selectedEndDate = null;
            this.init();
        }

        isPersianLeapYear(year) {
            return (((((year - 474) % 2820) + 474) + 38) * 682) % 2816 < 682;
        }

        init() {
            const enterDateVal = document.getElementById('enter_date').value;
            const exitDateVal = document.getElementById('exit_date').value;
            if (enterDateVal) {
                this.selectedStartDate = this.parseDate(enterDateVal);
                if (this.selectedStartDate < this.today) {
                    this.displayDate = new Date(this.selectedStartDate);
                }
            }
            if (exitDateVal) { this.selectedEndDate = this.parseDate(exitDateVal); }
            this.bindEvents();
            this.render();
            if (this.selectedStartDate && this.selectedEndDate) { this.updateDisplayInput(); }
        }

        parseDate(dateStr) {
            const parts = dateStr.split('-');
            return this.dateConverter.jalaliToGregorian(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]));
        }

        bindEvents() {
            document.getElementById('daterange-display').addEventListener('click', () => this.container.classList.toggle('active'));
            document.getElementById('prevMonth').addEventListener('click', () => this.changeMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => this.changeMonth(1));
            document.getElementById('applyBtn').addEventListener('click', () => this.applySelection());
            document.getElementById('cancelBtn').addEventListener('click', () => this.container.classList.remove('active'));
        }

        renderMonth(element, date) {
            const [jy, jm] = this.dateConverter.gregorianToJalali(date.getFullYear(), date.getMonth() + 1, 1);
            element.querySelector('.calendar-header span').textContent = `${this.persianMonths[jm - 1]} ${jy}`;
            const gridElement = element.querySelector('.calendar-grid');
            gridElement.innerHTML = '';
            
            // Wrap grid in a table for better range styling
            const table = document.createElement('table');
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);
            
            // Add headers
            const headerRow = document.createElement('tr');
            this.persianDays.forEach(day => {
                const th = document.createElement('th');
                th.className = 'calendar-day-header';
                th.textContent = day;
                headerRow.appendChild(th);
            });
            tbody.appendChild(headerRow);
            
            const firstDayOfMonth = this.dateConverter.jalaliToGregorian(jy, jm, 1).getDay();
            const startOffset = (firstDayOfMonth + 1) % 7;
            const daysInMonth = (jm <= 6) ? 31 : (jm <= 11) ? 30 : (this.isPersianLeapYear(jy) ? 30 : 29);

            let currentDay = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    if ((i === 0 && j < startOffset) || currentDay > daysInMonth) {
                        cell.innerHTML = '&nbsp;';
                    } else {
                        const day = currentDay;
                        const dayElement = document.createElement('button');
                        dayElement.type = 'button';
                        dayElement.className = 'calendar-day';
                        dayElement.textContent = day;
                        const currentDayGregorian = this.dateConverter.jalaliToGregorian(jy, jm, day);

                        if (currentDayGregorian < this.today) { dayElement.classList.add('disabled'); }
                        if (this.isSameDay(currentDayGregorian, this.today)) { dayElement.classList.add('today'); }
                        
                        if (this.selectedStartDate && this.selectedEndDate && currentDayGregorian > this.selectedStartDate && currentDayGregorian < this.selectedEndDate) { 
                            cell.classList.add('in-range'); 
                        }
                        if (this.selectedStartDate && this.isSameDay(currentDayGregorian, this.selectedStartDate)) { 
                            dayElement.classList.add('start-date');
                            if(this.selectedEndDate) cell.classList.add('in-range');
                        }
                        if (this.selectedEndDate && this.isSameDay(currentDayGregorian, this.selectedEndDate)) { 
                            dayElement.classList.add('end-date');
                             if(this.selectedStartDate) cell.classList.add('in-range');
                        }
                        
                        dayElement.addEventListener('click', () => this.selectDate(currentDayGregorian));
                        cell.appendChild(dayElement);
                        currentDay++;
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
                if (currentDay > daysInMonth) break;
            }
            gridElement.appendChild(table);
        }
        
        selectDate(date) {
            if (!this.selectedStartDate || (this.selectedStartDate && this.selectedEndDate)) {
                if (date < this.today) return; 
                this.selectedStartDate = date;
                this.selectedEndDate = null;
            } else if (date < this.selectedStartDate) {
                if (date < this.today) return;
                this.selectedEndDate = this.selectedStartDate;
                this.selectedStartDate = date;
            } else {
                this.selectedEndDate = date;
            }
            this.render();
        }

        changeMonth(offset) { this.displayDate.setMonth(this.displayDate.getMonth() + offset); this.render(); }
        
        applySelection() { 
            if (this.selectedStartDate && this.selectedEndDate) { 
                this.updateDisplayInput(); 
                this.container.classList.remove('active'); 
            } else { 
                alert('لطفا بازه تاریخی را کامل انتخاب کنید (تاریخ شروع و پایان).'); 
            } 
        }
        
        updateDisplayInput() { 
            const startJalali = this.dateConverter.gregorianToJalali(this.selectedStartDate.getFullYear(), this.selectedStartDate.getMonth() + 1, this.selectedStartDate.getDate()); 
            const endJalali = this.dateConverter.gregorianToJalali(this.selectedEndDate.getFullYear(), this.selectedEndDate.getMonth() + 1, this.selectedEndDate.getDate()); 
            const formatJalali = (d) => `${d[0]}-${String(d[1]).padStart(2, '0')}-${String(d[2]).padStart(2, '0')}`; 
            document.getElementById('daterange-display').value = `${formatJalali(startJalali)}   -   ${formatJalali(endJalali)}`; 
            document.getElementById('enter_date').value = formatJalali(startJalali); 
            document.getElementById('exit_date').value = formatJalali(endJalali); 
        }
        
        isSameDay(d1, d2) { 
            return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); 
        }
    }

    new PersianCalendar();
});
</script>
{% endblock %}
